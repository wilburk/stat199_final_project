---
title: "PROJECT TITLE"
author: "NAME HERE"
date: "TODAY'S DATE"
output: github_document
---

### Load Packages & Data

```{r load-packages-data}
library(stringr)
library(stringi)
library(tidyverse)
library(broom)
library(splitstackshape)
library(rpart)
library(rpart.plot)
library(RColorBrewer)
#library(sets)
library(rlist)

# run load-data.R first
food <- read_csv("data/food.csv")
food_attr <- read_csv("data/food-attributes.csv") 
food_hours <- read_csv("data/food-hours.csv")

food_attr <- food_attr %>% 
  select(-starts_with("DietaryRestrictions"))

food_attr_col <- colnames(food_attr) %>% 
  as.data.frame() %>%
  mutate(cols = str_replace(., "-", "_")) %>% 
  select(-.) %>% 
  pull()

colnames(food_attr) <- food_attr_col

### NOTE ###
# See fifth code black starting at line 275 
# for the code to get significant columns

```

```{r}
# food1 %>% 
#   filter(!is.na(attributes.NoiseLevel)) 
# 
# food1 %>%
#   filter(attributes.Alcohol != "full_bar") %>% 
#   select(attributes.Alcohol, categories)
# 
# food1 %>% 
#   count(attributes.RestaurantsPriceRange2)
```


### EDA -- Miles

Relevant Code: 

```{r message=FALSE}

food_attr_temp <- food_attr %>% 
  select(-business_id) %>% 
  mutate(BusinessParking =  BusinessParking.garage	  == TRUE	|	 	
                            BusinessParking.street    == TRUE |				
                            BusinessParking.validated	== TRUE	|	 
                            BusinessParking.lot       == TRUE |	
                            BusinessParking.valet     == TRUE,
         Music =  Music.dj                == TRUE |				
                  Music.background_music	== TRUE |			
                  Music.no_music		      == TRUE |		
                  Music.karaoke	          == TRUE |			
                  Music.live              == TRUE | 
                  Music.video             == TRUE |			
                  Music.jukebox	          == TRUE ,	
         Ambience = Ambience.romantic	== TRUE |			
                    Ambience.intimate	== TRUE |			
                    Ambience.classy		== TRUE |		
                    Ambience.hipster	== TRUE |			
                    Ambience.divey		== TRUE |		
                    Ambience.touristy	== TRUE |			
                    Ambience.trendy		== TRUE |		
                    Ambience.upscale  == TRUE |
                    Ambience.casual		== TRUE,	
         BestNights = BestNights.monday	  	== TRUE |	
                      BestNights.tuesday		== TRUE |			
                      BestNights.friday			== TRUE |		
                      BestNights.wednesday	== TRUE |				
                      BestNights.thursday		== TRUE |			
                      BestNights.sunday			== TRUE |		
                      BestNights.saturday		== TRUE,	
         GoodForMeal =  GoodForMeal.dessert   == TRUE |		
                        GoodForMeal.latenight	== TRUE |
                        GoodForMeal.lunch		  == TRUE |			
                        GoodForMeal.dinner		== TRUE |			
                        GoodForMeal.breakfast	== TRUE |		
                        GoodForMeal.brunch		== TRUE)	
         # DietaryRestrictions =  DietaryRestrictions.dairy_free	== TRUE |			
         #                        DietaryRestrictions.gluten_free	== TRUE |			
         #                        DietaryRestrictions.vegan				== TRUE |	
         #                        DietaryRestrictions.kosher			== TRUE |		
         #                        DietaryRestrictions.halal			  == TRUE |		
         #                        DietaryRestrictions.soy_free	  == TRUE |
         #                        DietaryRestrictions.vegetarian  == TRUE)

food_attr_temp[is.na(food_attr_temp)] <- 0
food_attr_temp[food_attr_temp != 0] <- 1

# test <- food_attr_temp %>%
#   summarise_all(funs(sum(. == "True"))) %>%
#   gather(attribute, true, 1:ncol(.))
# 
# food_attr_temp %>%
#   summarise_all(funs(sum(. == "False"))) %>%
#   gather(attribute, false, 1:ncol(.)) %>%
#   inner_join(test, by = "attribute") %>%
#   mutate(total = false + true,
#          perc_true = round(true / (false + true),2)) %>%
#   filter(total > 20, true > 0) %>%
#   arrange(desc(total))

food_attr_temp %>% 
  summarise_all(funs(sum(. == 1))) %>% 
  gather(attribute, total, 1:ncol(.)) %>% 
  arrange(desc(total)) %>% 
  filter(!str_detect(attribute, "\\."))


# numbers non null attribute values
food_attr_counts <- food_attr_temp %>% 
  summarise_all(funs(sum(. == 1))) %>% 
  gather(attribute, total, 1:ncol(.)) %>% 
  arrange(desc(total))
  #filter(!str_detect(attribute, "\\."))

food_attr_temp %>%
  mutate_all(funs(as.numeric(.))) %>% 
  select(1:65) %>% 
  mutate(sum = rowSums(.[1:65])) %>% 
  ggplot(aes(x = sum)) +
  geom_histogram()
 
level_props <- data.frame(attribute = colnames(food_attr)) %>% 
  filter(str_detect(attribute, "\\.")) %>% 
  inner_join(food_attr_counts, by = "attribute") %>% 
  mutate(attribute_parent = str_remove(attribute, "\\..+"),
         attribute = str_remove(attribute, ".+\\.")) %>%
  rename(subtotal = total) %>% 
  inner_join(food_attr_counts, by = c("attribute_parent" = "attribute")) %>% 
  mutate(prop = subtotal / total) %>% 
  mutate(subtotal = case_when(attribute == "hipster" ~ as.double(858),
                              attribute != "hipster" ~ as.double(subtotal))) %>% 
  arrange(attribute_parent, desc(prop)) 

level_props[4,2] <- 858
level_props[4,5] <- 0.03737
level_props

data.frame(attribute = colnames(food_attr)) %>% 
  filter(str_detect(attribute, "\\.")) %>% 
  inner_join(food_attr_counts, by = "attribute") %>% 
  mutate(attribute_parent = str_remove(attribute, "\\..+")) %>%
  rename(subtotal = total) %>% 
  inner_join(food_attr_counts, by = c("attribute_parent" = "attribute")) %>% 
  mutate(prop = subtotal / total) %>% 
  arrange(attribute_parent, desc(prop)) %>% 
  group_by(attribute_parent) %>% 
  summarise(undisjoint_factor = sum(subtotal) / median(total))

```


```{r}
convert_dot <- function(col_name) {
  col_name_short <- str_remove(col_name, ".+\\.")
  index <- grep(col_name, colnames(food_attr))
  col <- food_attr[index]
  col[col == TRUE] <- paste0(col_name_short, ",")
  col[col == FALSE] <- "."

  return(col)
}

lst <- food_attr %>% 
  select(contains(".")) %>% 
  colnames() 

food_attr_convert <- map(lst, convert_dot) %>% 
  as.data.frame()


food_attr_convert <- food_attr_convert %>% 
  mutate(aggBusinessParking =  paste0(BusinessParking.garage,	 	
                                      BusinessParking.street,			
                                      BusinessParking.validated,	 
                                      BusinessParking.lot,
                                      BusinessParking.valet, sep=""),
         aggMusic = paste0(Music.dj,				
                           Music.background_music,		
                           Music.no_music,
                           Music.karaoke	,
                           Music.live,
                           Music.video,			
                           Music.jukebox, sep=""),
         aggAmbience = paste0(Ambience.romantic,
                              Ambience.intimate,		
                              Ambience.classy	,	
                              Ambience.hipster,		
                              Ambience.divey	,	
                              Ambience.touristy,		
                              Ambience.trendy	,	
                              Ambience.upscale,
                              Ambience.casual, sep=""),
         aggBestNights = paste0(BestNights.monday	 ,	
                                BestNights.tuesday		,	
                                BestNights.friday			,
                                BestNights.wednesday	,		
                                BestNights.thursday		,	
                                BestNights.sunday			,
                                BestNights.saturday, sep=""),
         aggGoodForMeal = paste0(GoodForMeal.dessert,		
                                 GoodForMeal.latenight,
                                 GoodForMeal.lunch		  ,	
                                 GoodForMeal.dinner		,	
                                 GoodForMeal.breakfast	,
                                 GoodForMeal.brunch, sep="")) %>% 
  select(-contains(".")) %>% 
  mutate_all(funs(str_replace_all(.,",+", ","))) %>% 
  mutate_all(funs(str_replace_all(., "[NA]+", "NA"))) %>% 
  mutate_all(funs(str_remove_all(., "\\.NA|NA\\."))) %>% 
  mutate_all(funs(str_replace_all(., "^\\.+$", "None"))) %>% 
  mutate_all(funs(str_remove_all(., "\\.+"))) %>% 
  mutate_all(funs(str_remove(.,"^,"))) %>% 
  mutate_all(funs(str_remove(.,",$")))


food_attr_convert[food_attr_convert == "NA"] <- NA

### PROBLEM: too many collisions between variables - need to reduce to one value; don't want to eliminate too much information
### SOLUTION1: choose in order of frequency, low to high
### IMPLEMENTATION: iterate through, call function: if (numberofcommas + 1) > 1: split into vector, for each element in vector
### PROBLEM: if all slightly equal numbers but still collisions, some vals might not get seen

pick_index_min <- function(freq_vect) {
  return(grep(min(freq_vect), freq_vect))
}


pick_index_prob <- function(freq_vect) {
  ord_vect <- sort(freq_vect)
  total <- reduce(freq_vect, sum)
  ord_vect_prob <- sapply(ord_vect, function(x) x/total)
  rev_vect_prob <- sort(ord_vect_prob, decreasing = TRUE)
  for (i in 2:length(rev_vect_prob)){
    rev_vect_prob[[i]] <- rev_vect_prob[[i]] + rev_vect_prob[[i-1]]
  }
  rand <- runif(1)
  ind <- which(sapply(rev_vect_prob, function (x) x > rand))[[1]]
  return(grep(ord_vect[[ind]],freq_vect))
}

my_reduce <- function(col) {

  for (i in 1:length(col)) {
    val_list <- col[[i]]
    if (is.na(val_list) | val_list == "None" | !str_detect(val_list, ",")) {
      col[[i]] <- val_list
    } else {
      vals <- unlist(str_split(val_list, ","))
      freq_vect <- c()
      for (val in vals) {
        freq <- level_props %>%
          filter(attribute == val) %>%
          select(subtotal) %>%
          pull()
        freq_vect <- c(freq_vect, freq)
      }
      index <- pick_index_min(freq_vect)
      col[[i]] <- vals[index]
    }
  }
  return(col)
}

food_attr_reduce <- food_attr_convert %>% 
  mutate_all(funs(my_reduce))

```



```{r}


food_attr_mod_2 <- food_attr %>% 
  as.data.frame() %>% 
  select(-business_id) %>% 
  mutate(aggBusinessParking =  BusinessParking.garage	  == TRUE	|	 	
                            BusinessParking.street    == TRUE |				
                            BusinessParking.validated	== TRUE	|	 
                            BusinessParking.lot       == TRUE |	
                            BusinessParking.valet     == TRUE,
         aggMusic =  Music.dj                == TRUE |				
                  Music.background_music	== TRUE |			
                  Music.no_music		      == TRUE |		
                  Music.karaoke	          == TRUE |			
                  Music.live              == TRUE | 
                  Music.video             == TRUE |			
                  Music.jukebox	          == TRUE ,	
         aggAmbience = Ambience.romantic	== TRUE |			
                    Ambience.intimate	== TRUE |			
                    Ambience.classy		== TRUE |		
                    Ambience.hipster	== TRUE |			
                    Ambience.divey		== TRUE |		
                    Ambience.touristy	== TRUE |			
                    Ambience.trendy		== TRUE |		
                    Ambience.upscale  == TRUE |
                    Ambience.casual		== TRUE,	
         aggBestNights = BestNights.monday	  	== TRUE |	
                      BestNights.tuesday		== TRUE |			
                      BestNights.friday			== TRUE |		
                      BestNights.wednesday	== TRUE |				
                      BestNights.thursday		== TRUE |			
                      BestNights.sunday			== TRUE |		
                      BestNights.saturday		== TRUE,	
         aggGoodForMeal =  GoodForMeal.dessert   == TRUE |		
                        GoodForMeal.latenight	== TRUE |
                        GoodForMeal.lunch		  == TRUE |			
                        GoodForMeal.dinner		== TRUE |			
                        GoodForMeal.breakfast	== TRUE |		
                        GoodForMeal.brunch		== TRUE)	%>% 
  select(-starts_with("Ambience"),-starts_with("GoodForMeal"),-starts_with("Music"),-starts_with("BusinessParking"), -starts_with("BestNights"),-ByAppointmentOnly, -CoatCheck, -RestaurantsCounterService, -Corkage, -ByAppointmentOnly, -AgesAllowed, -BusinessAcceptsBitcoin, -BYOB, -Open24Hours)




food_attr_mod_2 <- food_attr %>% 
 # select(-business_id) %>%
  cbind(food_attr_reduce) %>% 
  select(business_id,BusinessAcceptsCreditCards,RestaurantsPriceRange2,GoodForKids,BikeParking,Alcohol,HasTV,NoiseLevel,RestaurantsAttire,RestaurantsGoodForGroups,Caters,WiFi,RestaurantsReservations,RestaurantsTakeOut, aggBusinessParking, aggAmbience, aggGoodForMeal) %>% 
  drop_na()


```


```{r linear regression}
#Used to merge stars to food attribute
food_stars <- food %>% 
  select(stars,business_id)

#food attr should be an aggregate dataset of all variables 
#categorical variables should have different level in one column
lm_data <- inner_join(food_stars,food_attr_mod_2,by= "business_id")

analysis1 <- lm_data %>% 
  select(stars,BusinessAcceptsCreditCards,RestaurantsPriceRange2,GoodForKids,BikeParking,Alcohol,HasTV,NoiseLevel,RestaurantsAttire,RestaurantsGoodForGroups,Caters,WiFi,RestaurantsReservations,RestaurantsTakeOut, aggBusinessParking, aggAmbience, aggGoodForMeal) 

 
#run linear analysis 
lm_a1 <- lm(stars ~ BusinessAcceptsCreditCards+RestaurantsPriceRange2+GoodForKids+BikeParking+Alcohol+HasTV+NoiseLevel+RestaurantsAttire+RestaurantsGoodForGroups+Caters+WiFi+RestaurantsReservations+RestaurantsTakeOut+aggBusinessParking+aggAmbience+aggGoodForMeal,data = analysis1)

AIC(lm_a1)
summary(lm_a1)$r.squared
```























```{r}
# values for each attribute
food_attr %>% 
  select(-business_id) %>% 
  gather(attribute, vals, 1:ncol(.)) %>% 
  distinct() %>% 
  filter(!is.na(vals) & vals != TRUE & vals != FALSE) 

# food_attr %>% 
#   mutate(AmbienceList = paste(case_when(Ambience.romantic == TRUE ~ "romantic,",
#                                          Ambience.romantic == FALSE ~ ""),
#                                case_when(Ambience.intimate == TRUE ~ "intimate,",
#                                          Ambience.intimate == FALSE ~ ""),
#                                case_when(Ambience.classy == TRUE ~ "classy,",
#                                          Ambience.classy == FALSE ~ ""),
#                                case_when(Ambience.casual == TRUE ~ "casual,",
#                                          Ambience.casual == FALSE ~ ""),
#                                case_when(Ambience.upscale == TRUE ~ "upscale,",
#                                          Ambience.upscale == FALSE ~ ""),
#                                case_when(Ambience.trendy == TRUE ~ "trendy,",
#                                          Ambience.trendy == FALSE ~ ""),
#                                case_when(Ambience.divey == TRUE ~ "divey,",
#                                          Ambience.divey == FALSE ~ ""),
#                                case_when(Ambience.touristy == TRUE ~ "touristy,",
#                                          Ambience.touristy == FALSE ~ ""),
#                                case_when(Ambience.hipster == TRUE ~ "hipster,",
#                                          Ambience.hipster == FALSE ~ ""), sep = "")) %>%
#   mutate(AmbienceList = str_remove_all(AmbienceList, "NA")) %>% 
#   select(starts_with("Ambience")) %>% 
#   count(AmbienceList) %>% 
#   arrange(desc(n))

# food_attr %>% 
#   t %>% 
#   as.data.frame() %>% 
#   rbind()
# 
# row.names(food_attr) <- food_attr$business_id
# 
# food_attr %>% 
#   mutate_all(funs(str_remove(names(.), ".+\\.")))

food_attr_mod <- food_attr %>% 
  as.data.frame() %>% 
  select(-business_id) %>% 
  mutate(aggBusinessParking =  BusinessParking.garage	  == TRUE	|	 	
                            BusinessParking.street    == TRUE |				
                            BusinessParking.validated	== TRUE	|	 
                            BusinessParking.lot       == TRUE |	
                            BusinessParking.valet     == TRUE,
         aggMusic =  Music.dj                == TRUE |				
                  Music.background_music	== TRUE |			
                  Music.no_music		      == TRUE |		
                  Music.karaoke	          == TRUE |			
                  Music.live              == TRUE | 
                  Music.video             == TRUE |			
                  Music.jukebox	          == TRUE ,	
         aggAmbience = Ambience.romantic	== TRUE |			
                    Ambience.intimate	== TRUE |			
                    Ambience.classy		== TRUE |		
                    Ambience.hipster	== TRUE |			
                    Ambience.divey		== TRUE |		
                    Ambience.touristy	== TRUE |			
                    Ambience.trendy		== TRUE |		
                    Ambience.upscale  == TRUE |
                    Ambience.casual		== TRUE,	
         aggBestNights = BestNights.monday	  	== TRUE |	
                      BestNights.tuesday		== TRUE |			
                      BestNights.friday			== TRUE |		
                      BestNights.wednesday	== TRUE |				
                      BestNights.thursday		== TRUE |			
                      BestNights.sunday			== TRUE |		
                      BestNights.saturday		== TRUE,	
         aggGoodForMeal =  GoodForMeal.dessert   == TRUE |		
                        GoodForMeal.latenight	== TRUE |
                        GoodForMeal.lunch		  == TRUE |			
                        GoodForMeal.dinner		== TRUE |			
                        GoodForMeal.breakfast	== TRUE |		
                        GoodForMeal.brunch		== TRUE)	%>% 
  select(-starts_with("Ambience"),-starts_with("GoodForMeal"),-starts_with("Music"),-starts_with("BusinessParking"), -starts_with("BestNights"),-ByAppointmentOnly, -CoatCheck, -RestaurantsCounterService, -Corkage, -ByAppointmentOnly, -AgesAllowed, -BusinessAcceptsBitcoin, -BYOB, -Open24Hours)

#GoodForDancing
#BYOBCorkage
#DogsAllowed
#DriveThru


# for (i in 1:ncol(food_attr)){
#   word <- str_remove(colnames(food_attr)[i], ".+\\.")
#   for (j in 1:nrow(food_attr)){
#       if (is.na(food_attr[j,i])) {
#         food_attr[j,i] = ""
#       } else {
#         food_attr[j,i] = word
#       }
#     }
# }

# food_attr_mod <- map(colnames(food_attr_mod), convert) %>% 
#    as.data.frame()


```


```{r}

### PLAN ###
# Create power set of all column names
# Create function that takes a list of column names
# Filter the attributes data set by list
# Calculate highest OPT score
# Increase number of attributes until OPT score goes down

convert <- function(col_name, tbl) {
  index <- grep(col_name, colnames(tbl))
  col <- tbl[index]
  col[!is.na(col)] <- paste0(col_name, ",")
  col[is.na(col)] <- ""
  return(col)
}

cols_eval <- function(col_names, tbl) {
  food_attr_local <- tbl
  index_vect = c()
  for (col_name in col_names) {
    j <- grep(col_name, colnames(tbl))
    index_vect <- c(index_vect, j)
  }
  food_attr_local <- food_attr_local[index_vect] %>% 
    as.data.frame()
  
  food_attr_local <- map(col_names, function(x) convert(x,tbl)) %>% 
  as.data.frame()
  
  
  # g <- food_attr_local %>% 
  #   unite(attr,sep = "", remove = TRUE) %>% 
  #   count(attr) %>% 
  #   mutate(num_attr = str_count(attr, ",")) %>%
  #   ggplot(aes(num_attr,n, color = num_attr * n)) +
  #   geom_point(size = 3)
  # 
  # print(g)
  
  i <<- i + 1
  
  result <- food_attr_local %>% 
    unite(attr,sep = "", remove = TRUE) %>% 
    count(attr) %>% 
    mutate(num_attr = str_count(attr, ","),
           opt_score = num_attr*n, 
           group = i) %>% 
    top_n(3, num_attr * n) %>% 
    arrange(desc(num_attr * n))
  return(result)
}


powerset <- function(vect) {
  total <- list()
  # m/2 -> m
  for (m in ((1*length(vect))%/%20):length(vect)) {
    x <- combn(vect,m)
    y <- split(x, rep(1:ncol(x), each = nrow(x)))
    total <- list.append(total,y)
  }
  return(total)
} 



# TEST CASE
# cols_eval(c("GoodForKids", "RestaurantsGoodForGroups", "HasTV", "RestaurantsPriceRange2", "BusinessAcceptsCreditCards"), food_attr_mod)
# pwrset <- powerset(c("GoodForKids", "RestaurantsGoodForGroups", "HasTV", "RestaurantsPriceRange2", "BusinessAcceptsCreditCards")) 
# 
# result <- list()
# for (test_cols_wrap in pwrset){
#   for (test_cols in test_cols_wrap) {
#     temp <- c()
#     for (test_col in test_cols) {
#       temp <- c(temp, test_col)
#     }
#     result <- list.append(result,cols_eval(temp, food_attr_mod))
#   }
# }
# 
# resultdf <- as.data.frame(do.call("rbind", result))


find_best_cols <- function(tbl) {
  
  pwrset <- powerset(colnames(tbl))
  #print(pwrset)
  # for (test_col in pwrset){
  #   find_best_cols(test_col)
  # }
  i <<- 0
  final_lst <- list()
  for (test_cols_wrap in pwrset){
    for (test_cols in test_cols_wrap) {
      temp <- c()
      for (test_col in test_cols) {
        temp <- c(temp, test_col)
      }
    final_lst <- list.append(final_lst,cols_eval(temp, tbl))
    }
  
  }

  final_df <- as.data.frame(do.call("rbind", final_lst)) %>% 
    distinct() %>%
    mutate(group = as.factor(group))
  
  #final <- map_df(pwrset, function(x) cols_eval(x, tbl))
  
  g <- final_df %>%
    ggplot(aes(num_attr, n, color = opt_score)) +
    geom_point(size = 4) +
    #scale_color_distiller(palette = "RdBu", type = "div", direction = 1)
    scale_color_distiller(palette = "OrRd", direction = 1) + 
    theme_minimal()

  print(g)
  
  return(final_df %>% 
    arrange(desc(num_attr), desc(n)))
}
food_attr
# This might take a while
find_best_cols(food_attr_mod[24:28])

food_attr_mod

#### aggBusinessParking,aggAmbience,aggGoodForMeal,


food_attr 

food_attr_mod_2 <- food_attr %>% 
  select(-business_id) %>%
  cbind(food_attr_reduce) %>% 
#  select(-starts_with("Ambience"),-starts_with("GoodForMeal"),-starts_with("Music"),-starts_with("BusinessParking"), -starts_with("BestNights"),-ByAppointmentOnly, -CoatCheck, -RestaurantsCounterService, -Corkage, -ByAppointmentOnly, -AgesAllowed, -BusinessAcceptsBitcoin, -BYOB, -Open24Hours%>% 
  select(BusinessAcceptsCreditCards,RestaurantsPriceRange2,GoodForKids,BikeParking,Alcohol,HasTV,NoiseLevel,RestaurantsAttire,RestaurantsGoodForGroups,Caters,WiFi,RestaurantsReservations,RestaurantsTakeOut, aggBusinessParking, aggAmbience, aggGoodForMeal) %>% 

  drop_na()

```




```{r}
#aggregate food_attr data 
#recode true to the name and false to na, and then aggregate all the columns 
food_attr_1 <- food_attr %>% 
  mutate(BusinessParking.garage = case_when(
    BusinessParking.garage == TRUE ~ "garage",
    BusinessParking.street == TRUE ~ "street",
    BusinessParking.validated == TRUE ~ "validated",
    BusinessParking.lot == TRUE ~ "lot",
    BusinessParking.valet == TRUE ~ "valet"
    ))

food_attr_recode <- food_attr

food_attr_recode$BusinessParking.garage[food_attr_recode$BusinessParking.garage == TRUE] <- "garage"
food_attr_recode$BusinessParking.garage[food_attr_recode$BusinessParking.garage == FALSE] <- NA
 
food_attr_recode

```





```{r}
### THese are the most significant columns I found

# aggBusinessParking,aggMusic,aggAmbience,aggGoodForMeal,
# aggBusinessParking,aggMusic,aggBestNights,aggGoodForMeal,
# aggBusinessParking,aggAmbience,aggGoodForMeal,        highest n
# aggBusinessParking,aggMusic,aggAmbience,
# 




# BusinessAcceptsCreditCards,RestaurantsPriceRange2,GoodForKids,Alcohol,HasTV,NoiseLevel,RestaurantsAttire,RestaurantsGoodForGroups,WiFi,RestaurantsReservations,RestaurantsTakeOut

# BusinessAcceptsCreditCards,RestaurantsPriceRange2,GoodForKids,BikeParking,Alcohol,HasTV,NoiseLevel,RestaurantsAttire,RestaurantsGoodForGroups,WiFi,RestaurantsReservations,RestaurantsTakeOut,

# BusinessAcceptsCreditCards,RestaurantsPriceRange2,GoodForKids,BikeParking,Alcohol,HasTV,NoiseLevel,RestaurantsAttire,RestaurantsGoodForGroups,Caters,WiFi,RestaurantsReservations,RestaurantsTakeOut,

convert_dot <- function(col_name) {
  col_name_short <- str_remove(col_name, ".+\\.")
  index <- grep(col_name, colnames(food_attr))
  col <- food_attr[index]
  col[col == TRUE] <- paste0(col_name_short, ",")
  col[col == FALSE] <- "."

  return(col)
}

convert_dot("BusinessParking.lot")

lst <- food_attr %>% 
  select(contains(".")) %>% 
  colnames() 

food_attr_convert <- map(lst, convert_dot) %>% 
  as.data.frame()


food_attr_convert <- food_attr_convert %>% 
  mutate(aggBusinessParking =  paste0(BusinessParking.garage,	 	
                                      BusinessParking.street,			
                                      BusinessParking.validated,	 
                                      BusinessParking.lot,
                                      BusinessParking.valet, sep=""),
         aggMusic = paste0(Music.dj,				
                           Music.background_music,		
                           Music.no_music,
                           Music.karaoke	,
                           Music.live,
                           Music.video,			
                           Music.jukebox, sep=""),
         aggAmbience = paste0(Ambience.romantic,
                              Ambience.intimate,		
                              Ambience.classy	,	
                              Ambience.hipster,		
                              Ambience.divey	,	
                              Ambience.touristy,		
                              Ambience.trendy	,	
                              Ambience.upscale,
                              Ambience.casual, sep=""),
         aggBestNights = paste0(BestNights.monday	 ,	
                                BestNights.tuesday		,	
                                BestNights.friday			,
                                BestNights.wednesday	,		
                                BestNights.thursday		,	
                                BestNights.sunday			,
                                BestNights.saturday, sep=""),
         aggGoodForMeal = paste0(GoodForMeal.dessert,		
                                 GoodForMeal.latenight,
                                 GoodForMeal.lunch		  ,	
                                 GoodForMeal.dinner		,	
                                 GoodForMeal.breakfast	,
                                 GoodForMeal.brunch, sep="")) %>% 
  select(-contains(".")) %>% 
  mutate_all(funs(str_replace_all(.,",+", ","))) %>% 
  mutate_all(funs(str_replace_all(., "[NA]+", "NA"))) %>% 
  mutate_all(funs(str_remove_all(., "\\.NA|NA\\."))) %>% 
  mutate_all(funs(str_replace_all(., "^\\.+$", "None"))) %>% 
  mutate_all(funs(str_remove_all(., "\\.+"))) %>% 
  mutate_all(funs(str_remove(.,"^,"))) %>% 
  mutate_all(funs(str_remove(.,",$")))


food_attr_convert[food_attr_convert == "NA"] <- NA

test <- food_attr_convert %>% 
  head(100)

### PROBLEM: too many collisions between variables - need to reduce to one value; don't want to eliminate too much information
### SOLUTION1: choose in order of frequency, low to high
### IMPLEMENTATION: iterate through, call function: if (numberofcommas + 1) > 1: split into vector, for each element in vector
### PROBLEM: if all slightly equal numbers but still collisions, some vals might not get seen

# my_reduce2 <- function(col) {
# 
#   indices <- which(apply(col %>% data.frame(), MARGIN = 1, FUN = (function(val_list) !is.na(val_list) & str_detect(val_list, ","))))
# 
#   for (i in indices) {
#     val_list <- col[[i]]
#     vals <- unlist(str_split(val_list, ","))
#       freq_vect <- c()
#       for (val in vals) {
#         freq <- level_props %>% 
#           filter(attribute == val) %>% 
#           select(subtotal) %>% 
#           pull()
#         freq_vect <- c(freq_vect, freq)
#       }
#       col[[i]] <- vals[grep(min(freq_vect), freq_vect)]
#   }
#   return(col)
# }
pick_index_min <- function(freq_vect) {
  return(grep(min(freq_vect), freq_vect))
  #[[1]]
}

pick_index_prob <- function(freq_vect) {
  #print(freq_vect)
  ord_vect <- sort(freq_vect)
  total <- reduce(freq_vect, sum)
  ord_vect_prob <- sapply(ord_vect, function(x) x/total)
  #print(ord_vect)

  rev_vect_prob <- sort(ord_vect_prob, decreasing = TRUE)
  for (i in 2:length(rev_vect_prob)){
    rev_vect_prob[[i]] <- rev_vect_prob[[i]] + rev_vect_prob[[i-1]]
  }
  #print(rev_vect_prob)
  
  rand <- runif(1)
  #print(rand)
  #print(sapply(rev_vect_prob, function (x) x > rand))
  #print(which(sapply(rev_vect_prob, function (x) x > rand)))
  #print(which(sapply(rev_vect_prob, function (x) x > rand))[[1]])
  ind <- which(sapply(rev_vect_prob, function (x) x > rand))[[1]]
  #print(ord_vect[[ind]])
  #print(grep(ord_vect[[ind]],freq_vect))
  #ind <- grep(which(sapply(rev_vect_prob, function (x) x > rand))[[1]], ord_vect)
  
  return(grep(ord_vect[[ind]],freq_vect))
}

food_attr %>% 
  cbind(food_attr_reduce) %>% 
  select(-business_id)

my_reduce <- function(col) {

  for (i in 1:length(col)) {
    val_list <- col[[i]]
    if (is.na(val_list) | val_list == "None" | !str_detect(val_list, ",")) {
      col[[i]] <- val_list
    } else {
      vals <- unlist(str_split(val_list, ","))
      freq_vect <- c()
      for (val in vals) {
        freq <- level_props %>%
          filter(attribute == val) %>%
          select(subtotal) %>%
          pull()
        freq_vect <- c(freq_vect, freq)
      }
      index <- pick_index_min(freq_vect)
      col[[i]] <- vals[index]
    }
  }
  return(col)
}

#level_props

food_attr_convert %>% 
  filter(str_detect(aggBestNights, ',')) %>% 
  select(aggBestNights) %>% 
  head(10000) %>% 
  mutate_all(funs(my_reduce)) %>% 
  count(aggBestNights) %>% 
  arrange(desc(n))

food_attr_convert$aggBestNights

#my_reduce(food_attr_convert$aggAmbience)

food_attr_reduce <- food_attr_convert %>% 
  mutate_all(funs(my_reduce))


food_attr_reduce <- food_attr %>% 






# food_attr_reduce %>% 
#   count(aggAmbience) %>% 
#   arrange(desc(n))

```



```{r}
food_tall <- food %>% 
  cSplit("categories", direction = "tall", sep = ",") 

food_tall %>% 
  count(categories) %>% 
  arrange(desc(n))

food %>% 
  count(categories) %>% 
  arrange(desc(n))

food %>% 
  count(categories) %>% 
  arrange(desc(n)) %>%
  filter(n > 50) %>% 
  ggplot(aes(n)) + 
  geom_histogram()

food_tall %>% 
  count(categories) %>% 
  filter(n > 10) %>% 
  ggplot(aes(n)) + 
  geom_histogram()
```

```{r}
ggplot(food_attr, aes(NoiseLevel))+
  geom_histogram(stat="count")
```


```{r}




# ratings by alcohol & good for kids
food %>% 
  filter(!is.na(attributes.Alcohol), !is.na(attributes.GoodForKids)) %>% 
  group_by(attributes.GoodForKids, attributes.Alcohol) %>% 
  summarise(mean = mean(stars),
            n = n())

# get top # cities
food_small %>% 
  count(city) %>% 
  arrange(desc(n))

# filter for toronto, non null neighborhoods
toronto_neighborhood <- food_small %>% 
  filter(city == "Toronto", neighborhood != "")

# look at top neighborhoods
toronto_neighborhood %>%
  count(neighborhood) %>% 
  arrange(desc(n))

# aggregate postal codes (heirarchical structure so just took two few numbers)
toronto_neighborhood <- toronto_neighborhood %>%
  mutate(postal_code_short = substr(postal_code, 1 , 2)) %>% 
  filter(postal_code_short != "L1" & postal_code_short != "L3" & postal_code_short != "L5")

# summary stats by neighborhood
toronto_neighborhood %>% 
  group_by(neighborhood) %>% 
  summarise(mean = mean(stars), n = n()) %>% 
  filter(n > 10) %>% 
  arrange(desc(mean))

# kmeans by attributes 7 through 10
kmns <- kmeans(toronto_neighborhood[8:11], 10)

# view kmeans results
head(augment(kmns, toronto_neighborhood))
tidy(kmns)

# view postal codes in space
toronto_neighborhood %>% 
  filter(postal_code_short != "") %>% 
  ggplot(aes(x = latitude, y = longitude, color = postal_code_short)) +
  geom_point(alpha = 1, size = 1)
```
### kmeans

```{r}
# kmeans exploratory analysis
kmns <- data.frame(k=1:9) %>% 
  group_by(k) %>% 
  do(kmns = kmeans(toronto_neighborhood[8:9], .$k))

clusters <- kmns %>%
    group_by(k) %>%
    do(tidy(.$kmns[[1]]))

assignments <- kmns %>%
    group_by(k) %>%
    do(augment(.$kmns[[1]], toronto_neighborhood))

clusterings <- kmns %>%
    group_by(k) %>%
    do(glance(.$kmns[[1]]))

ggplot(assignments, aes(latitude, longitude)) +
    geom_point(aes(color=.cluster), alpha = 0.33, size = 0.2) +
    facet_wrap(~ k)
```

```{r}

toronto_neighborhood_tall <- toronto_neighborhood %>% 
  cSplit("categories", direction = "tall", sep = ",") 


# 7560
toronto_neighborhood %>% 
  nrow()

# get list of major categories
major_categories <- toronto_neighborhood_tall %>% 
  count(categories) %>% 
  filter(n > 18) %>%
  arrange(desc(n)) %>% 
  pull(categories)

# filters to 7365 - good!
toronto_neighborhood_tall <- toronto_neighborhood_tall %>% 
  filter(categories %in% major_categories) %>% 
  head(200)
  

rpart.control(minbucket=2)
#fit <- rpart(postal_code ~ neighborhood, method = "class", data = toronto_neighborhood_tall)


printcp(fit) # display the results 
plotcp(fit) # visualize cross-validation results 
summary(fit) # detailed summary of splits
rsq.rpart(fit)
# plot tree 
# plot(fit, uniform=TRUE, 
#   	main="Regression Tree for Stars")
# text(fit, use.n=TRUE, all=TRUE, cex=.8)


#fancyRpartPlot(fit)

```
BusinessAcceptsCreditCards,RestaurantsPriceRange2,GoodForKids,BikeParking,Alcohol,HasTV,NoiseLevel,RestaurantsAttire,RestaurantsGoodForGroups,Caters,WiFi,RestaurantsReservations,RestaurantsTakeOut, aggBusinessParking, aggAmbience, aggGoodForMeal
```{r rpart regression tree}


  fit <- rpart(stars ~ BusinessAcceptsCreditCards+RestaurantsPriceRange2+GoodForKids+BikeParking+Alcohol+HasTV+NoiseLevel+RestaurantsAttire+RestaurantsGoodForGroups+Caters+WiFi+RestaurantsReservations+RestaurantsTakeOut+aggBusinessParking+aggAmbience+aggGoodForMeal, method = "anova", data = analysis1)

printcp(fit) # display the results 
plotcp(fit) # visualize cross-validation results 
summary(fit) # detailed summary of splits

par(mfrow=c(1,2)) # two plots on one page 
rsq.rpart(fit) # visualize cross-validation results  

prune(fit, cp = 0.02)

plot(fit, uniform=TRUE, 
  	main="Regression Tree for Mileage ")
text(fit, use.n=TRUE, all=TRUE, cex=.8)

```





### EDA -- Katie


### EDA -- Ivy
```{r}
food_attr

```


Regression analysis for first set of attributes
```{r}
#Used to merge stars to food attribute
food_stars <- food %>% 
  select(stars)

#food attr should be an aggregate dataset of all variables 
#categorical variables should have different level in one column
lm_data <- cbind(food_stars,food_attr)

analysis1 <- lm_data %>% 
  select(stars,BusinessAcceptsCreditCards,RestaurantsPriceRange2,GoodForKids,Alcohol,HasTV,NoiseLevel,RestaurantsAttire,RestaurantsGoodForGroups,WiFi,RestaurantsReservations,RestaurantsTakeOut) 

#omit Nas in analysis 1
omit_a1 <- na.omit(analysis1)
 
#run linear analysis 
lm_a1 <- lm(stars ~ BusinessAcceptsCreditCards+RestaurantsPriceRange2+GoodForKids+Alcohol+HasTV+NoiseLevel+RestaurantsAttire+RestaurantsGoodForGroups+WiFi+RestaurantsReservations+RestaurantsTakeOut,data = omit_a1)

AIC(lm_a1)
summary(lm_a1)$r.squared
```



```{r}
analysis2 <- lm_data %>% 
  select(stars,BusinessAcceptsCreditCards,RestaurantsPriceRange2,GoodForKids,BikeParking,Alcohol,HasTV,NoiseLevel,RestaurantsAttire,RestaurantsGoodForGroups,Caters,WiFi,RestaurantsReservations,RestaurantsTakeOut,RestaurantsTableService,OutdoorSeating,RestaurantsDelivery,aggBusinessParking,aggAmbience,aggGoodForMeal) 

#omit Nas in analysis 2
omit_a2 <-na.omit(analysis2)
 
#run linear analysis 
lm_a2 <- lm(stars ~ BusinessAcceptsCreditCards+RestaurantsPriceRange2+GoodForKids+BikeParking+Alcohol+HasTV+NoiseLevel+RestaurantsAttire+RestaurantsGoodForGroups+Caters+WiFi+RestaurantsReservations+RestaurantsTakeOut+RestaurantsTableService+OutdoorSeating+RestaurantsDelivery+aggBusinessParking+aggAmbience+aggGoodForMeal,data = omit_a2)

AIC(lm_a2)
summary(lm_a2)$r.squared
```


```{r}
library()
```

